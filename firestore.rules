
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ORGANIZATION
    match /organizations/{orgId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.ownerId;
    }

    // USERS
    // Owners can manage all users in their org. Users can read their own profile.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.organizationId == resource.data.organizationId);
      allow write: if request.auth != null && request.auth.token.organizationId == resource.data.organizationId && request.auth.token.role == 'owner';
    }

    // STADIUMS
    // Owners can manage stadiums in their org. Coaches can read their assigned stadiums.
    match /stadiums/{stadiumId} {
      allow read: if request.auth != null && (
        (request.auth.token.role == "owner" && request.auth.token.organizationId == resource.data.organizationId) ||
        (request.auth.token.role == "coach" && request.auth.uid == resource.data.assignedCoachId)
      );
      allow write: if request.auth != null && 
        request.auth.token.role == "owner" && 
        request.auth.token.organizationId == resource.data.organizationId;
    }
    
    // STUDENTS
    // Owners can manage students in their org. Coaches can manage students in their assigned stadium.
    match /stadiums/{stadiumId}/students/{studentId} {
      allow read, write: if request.auth != null && (
        (request.auth.token.role == "owner" && request.auth.token.organizationId == resource.data.organizationId) ||
        (request.auth.token.role == "coach" && request.auth.uid == get(/databases/$(database)/documents/stadiums/$(stadiumId)).data.assignedCoachId)
      );
    }
    
    // ATTENDANCE
    // Owners can read all attendance. Coaches can manage attendance for their stadium.
     match /stadiums/{stadiumId}/attendance/{attendanceId} {
      allow read: if request.auth != null && request.auth.token.organizationId == resource.data.organizationId;
      allow write: if request.auth != null && 
        request.auth.token.role == "coach" &&
        request.auth.uid == get(/databases/$(database)/documents/stadiums/$(stadiumId)).data.assignedCoachId;
    }
  }
}
